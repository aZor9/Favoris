<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Page d'accueil personnalis√©e</title>
  <style>
    /* sensible defaults for responsive behaviour */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      background: #eef2f5;
      text-align: center;
      padding-top: 5%;
    }
    a {
      display: inline-block;
      margin: 10px;
      padding: 8px 16px;
      background: white;
      border-radius: 8px;
      text-decoration: none;
      color: #333;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #005fcc; }
    /* edit button: fixed bottom-right */
    #editBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      border-radius: 999px;
      padding: 12px 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* reset button: fixed near edit button, hidden by default and shown in edit mode */
    #resetBtn {
      background: #e53935;
      position: fixed;
      bottom: 20px;
      right: 110px;
      z-index: 1000;
      display: none;
      border-radius: 8px;
      padding: 10px 14px;
    }
    #resetBtn:hover { background: #b71c1c; }
    /* background image layer */
    #bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      filter: blur(8px) brightness(0.6);
      transition: background-image 0.3s ease-in-out, opacity 0.3s;
    }
    /* ensure main content is above background */
    body > *:not(#bg) {
      position: relative;
      z-index: 1;
    }
    /* title contrast helpers */
    h1.light-title {
      color: #ffffff;
      text-shadow: 0 4px 18px rgba(0,0,0,0.7);
    }
    h1.dark-title {
      color: #111111;
      text-shadow: 0 2px 6px rgba(255,255,255,0.5);
    }
    /* default settings-panel behavior (overridable by media queries) */
  .settings-panel { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px; }
  input { padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 120px; max-width: 720px; }
    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,120,255,0.12); }
    button { font-size: 14px; }
  /* link item defaults (moved from JS inline styles) */
  .link-item { display: inline-block; position: relative; margin: 6px; }
  .link-anchor { cursor: pointer; padding: 8px 12px; display: inline-block; }
    /* Responsive rules for small screens (phones) */
    @media (max-width: 600px) {
      body { padding-top: 8%; text-align: center; }
      h1 { font-size: 1.6rem; margin: 0 12px 12px; }

      /* make the links container a vertical list on small screens */
      #links { display: flex; flex-direction: column; align-items: center; padding: 0 12px; }

      /* make link items stack and be easy to tap */
      .link-item { display: block; width: 100%; max-width: 560px; margin: 8px auto; }
      .link-item .link-anchor {
        display: block !important;
        width: 100% !important;
        margin: 6px 0 !important;
        padding: 12px !important;
        box-sizing: border-box;
        text-align: left;
        word-break: break-word;
      }
      .link-item button { margin-left: 6px; margin-top: 6px; padding: 8px 10px; }

      /* settings panel flows vertically on phones */
  .settings-panel { flex-direction: column !important; align-items: stretch !important; gap: 8px !important; }
  .settings-panel input { width: calc(100% - 32px) !important; max-width: 560px !important; margin: 0 auto !important; }
      .settings-panel button { width: auto !important; }

      /* smaller fixed edit/reset buttons */
      #editBtn { right: 14px; bottom: 14px; padding: 10px 12px; }
      #resetBtn { right: 84px; bottom: 14px; padding: 8px 10px; }

      /* slightly reduce blur on small devices for performance */
      #bg { filter: blur(6px) brightness(0.6); }
      /* when in edit mode, add padding under links so fixed buttons don't overlap content */
      body.editing #links { padding-bottom: 220px; }
    }
    /* Extra adjustments for very small screens to avoid overlap */
    @media (max-width: 420px) {
      #editBtn {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        bottom: 12px;
        padding: 12px 14px;
      }
      #resetBtn {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        bottom: 68px;
        display: none; /* hide by default to save space; it will be shown in edit mode by JS */
      }
      /* ensure reset shows in edit mode: JS toggles inline style display; we set a visible size here */
      .show-reset #resetBtn { display: inline-block !important; }
      .link-item .link-anchor { font-size: 16px; padding: 14px !important; }
      /* on very small screens increase bottom padding when editing to avoid overlap */
      body.editing #links { padding-bottom: 320px; }
    }
    .add-link { margin-top: 12px; }
  </style>
</head>
<body>
  <div id="bg"></div>
  <h1>Ma page d'accueil üåü</h1>
  <div id="links"></div>
  <div>
    <button id="editBtn" onclick="toggleEditMode()">Personnaliser</button>
    <button onclick="resetStorage()" id="resetBtn">R√©initialiser</button>
  </div>

  <script>
    const defaultLinks = [
      { name: "Google", url: "https://www.google.com" },
      { name: "YouTube", url: "https://www.youtube.com" },
      { name: "LinkedIn", url: "https://www.linkedin.com" },
      { name: "Netflix", url: "https://www.netflix.com" },
      { name: "Gmail", url: "https://www.gmail.com" }
    ];

    function getLinks() {
      return JSON.parse(localStorage.getItem("links")) || defaultLinks;
    }

    let editMode = false;

    // Apply saved settings (title, background) on load
    function loadSettings() {
      const storedTitle = localStorage.getItem('pageTitle');
      if (storedTitle) {
        document.title = storedTitle;
        const h = document.querySelector('h1');
        if (h) h.textContent = storedTitle;
      }
      const bg = localStorage.getItem('bgImage');
      if (bg) applyBackground(bg);
      else updateTitleContrast(null);
    }

    // Estimate image brightness by drawing it to a small canvas.
    // If cross-origin blocks canvas readback, fallback to conservative choice.
    function analyzeImageBrightness(url, cb) {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = () => {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const w = 40, h = 30;
          canvas.width = w; canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          const data = ctx.getImageData(0, 0, w, h).data;
          let r=0,g=0,b=0,count=0;
          for (let i=0;i<data.length;i+=4) {
            r += data[i]; g += data[i+1]; b += data[i+2]; count++;
          }
          r = r/count; g = g/count; b = b/count;
          const lum = 0.299*r + 0.587*g + 0.114*b;
          cb(null, lum);
        } catch (err) {
          cb(err);
        }
      };
      img.onerror = () => cb(new Error('image load error'));
      img.src = url + ((url.indexOf('?')>-1)?'&':'?') + 'cachebust=' + Date.now();
    }

    function updateTitleContrast(bgUrl) {
      const h = document.querySelector('h1');
      if (!h) return;
      h.classList.remove('light-title','dark-title');
      if (!bgUrl) { h.classList.add('dark-title'); return; }
      analyzeImageBrightness(bgUrl, (err, lum) => {
        if (err || lum === undefined) { h.classList.add('dark-title'); return; }
        if (lum < 130) h.classList.add('light-title'); else h.classList.add('dark-title');
      });
    }

    function saveSettings(title, bgUrl) {
      if (title !== undefined) {
        localStorage.setItem('pageTitle', title);
        document.title = title;
        const h = document.querySelector('h1');
        if (h) h.textContent = title;
      }
      if (bgUrl !== undefined) {
        // validate image first
        if (!bgUrl) {
          // clear background
          localStorage.removeItem('bgImage');
          applyBackground(null);
          return;
        }
        const img = new Image();
        img.onload = () => {
          localStorage.setItem('bgImage', bgUrl);
          applyBackground(bgUrl);
        };
        img.onerror = () => {
          alert('Impossible de charger l\'image de fond. V√©rifie l\'URL.');
        };
        img.src = bgUrl;
      }
    }

    function applyBackground(url) {
      const bgDiv = document.getElementById('bg');
      if (!bgDiv) return;
      if (!url) {
        bgDiv.style.backgroundImage = 'none';
        document.body.style.background = '#eef2f5';
        updateTitleContrast(null);
        return;
      }
      bgDiv.style.backgroundImage = `url(${url})`;
      bgDiv.style.backgroundSize = 'cover';
      bgDiv.style.backgroundPosition = 'center';
      // dim and blur are handled by CSS filter
      document.body.style.background = 'transparent';
      updateTitleContrast(url);
    }

    function renderLinks() {
      const container = document.getElementById("links");
      container.innerHTML = "";
      // If in edit mode, show settings panel for title and background
      if (editMode) {
        const settings = document.createElement('div');
        settings.className = 'settings-panel';

        const titleInput = document.createElement('input');
        titleInput.placeholder = 'Titre de la page';
        titleInput.value = localStorage.getItem('pageTitle') || document.querySelector('h1').textContent || '';

        const bgInput = document.createElement('input');
        bgInput.placeholder = 'URL de l\'image de fond (laisser vide pour effacer)';
        bgInput.value = localStorage.getItem('bgImage') || '';

        const saveSettingsBtn = document.createElement('button');
        saveSettingsBtn.textContent = 'Enregistrer param√®tres';
        saveSettingsBtn.onclick = () => {
          saveSettings(titleInput.value, bgInput.value);
        };

        const cancelSettingsBtn = document.createElement('button');
        cancelSettingsBtn.textContent = 'Annuler';
        cancelSettingsBtn.onclick = () => { renderLinks(); };

        settings.appendChild(titleInput);
        settings.appendChild(bgInput);
        settings.appendChild(saveSettingsBtn);
        settings.appendChild(cancelSettingsBtn);
        container.appendChild(settings);
      }
      const links = getLinks();
      links.forEach((link, idx) => {
  const item = document.createElement('div');
  item.className = 'link-item';

  const a = document.createElement("a");
  a.className = 'link-anchor';
  a.href = link.url;
  a.textContent = link.name || link.url;

        if (editMode) {
          // prevent navigation in edit mode; clicking edits
          a.addEventListener('click', (e) => { e.preventDefault(); editLink(idx); });
        } else {
          // open links in the same page
          a.target = '_self';
        }

        item.appendChild(a);

        if (editMode) {
          const editBtn = document.createElement('button');
          editBtn.textContent = '‚úé';
          editBtn.title = 'Modifier';
          editBtn.style.marginLeft = '6px';
          editBtn.onclick = () => editLink(idx);
          item.appendChild(editBtn);

          const delBtn = document.createElement('button');
          delBtn.textContent = 'üóë';
          delBtn.title = 'Supprimer';
          delBtn.style.marginLeft = '4px';
          delBtn.onclick = () => { removeLink(idx); };
          item.appendChild(delBtn);
        }

        container.appendChild(item);
      });

      if (editMode) {
        const add = document.createElement('div');
        add.className = 'add-link';
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Ajouter un lien';
        addBtn.onclick = addLink;
        add.appendChild(addBtn);
        container.appendChild(add);
      }
    }

    function toggleEditMode() {
      editMode = !editMode;
      document.getElementById('editBtn').textContent = editMode ? 'Terminer' : 'Personnaliser';
      // show/hide reset button depending on edit mode
      const reset = document.getElementById('resetBtn');
      if (reset) reset.style.display = editMode ? 'inline-block' : 'none';
      // toggle body classes so mobile CSS can add bottom padding and show reset when needed
      if (editMode) {
        document.body.classList.add('editing');
        document.body.classList.add('show-reset');
      } else {
        document.body.classList.remove('editing');
        document.body.classList.remove('show-reset');
      }
      renderLinks();
    }

    function editLink(index) {
      const links = getLinks();
      const container = document.getElementById('links');
      // replace the specific item with an edit form
      const items = Array.from(container.children).filter(n => n.nodeType === 1);
      const target = items[index];
      if (!target) return;

      const form = document.createElement('div');
      form.style.display = 'inline-block';
      form.style.padding = '8px';
      form.style.background = '#fff';
      form.style.borderRadius = '6px';
      form.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

      const nameInput = document.createElement('input');
      nameInput.value = links[index]?.name || '';
      nameInput.placeholder = 'Nom';
      nameInput.style.marginRight = '6px';

      const urlInput = document.createElement('input');
      urlInput.value = links[index]?.url || 'https://';
      urlInput.placeholder = 'https://...';
      urlInput.style.marginRight = '6px';
      urlInput.style.width = '220px';

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Enregistrer';
      saveBtn.onclick = () => {
        links[index] = { name: nameInput.value || urlInput.value, url: urlInput.value };
        localStorage.setItem('links', JSON.stringify(links));
        renderLinks();
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Annuler';
      cancelBtn.style.marginLeft = '6px';
      cancelBtn.onclick = () => { renderLinks(); };

      form.appendChild(nameInput);
      form.appendChild(urlInput);
      form.appendChild(saveBtn);
      form.appendChild(cancelBtn);

      target.replaceWith(form);
      nameInput.focus();
    }

    function addLink() {
      const links = getLinks();
      links.push({ name: '', url: 'https://' });
      localStorage.setItem('links', JSON.stringify(links));
      renderLinks();
      // open editor for the new last item
      setTimeout(() => editLink(links.length - 1), 50);
    }

    function removeLink(index) {
      const links = getLinks();
      links.splice(index, 1);
      localStorage.setItem('links', JSON.stringify(links));
      renderLinks();
    }

    function resetStorage() {
      const ok = confirm("Voulez-vous vraiment r√©initialiser les liens enregistr√©s ? Cela restaurera les valeurs par d√©faut.");
      if (!ok) return;
      localStorage.removeItem("links");
      renderLinks();
      alert("Les liens ont √©t√© r√©initialis√©s aux valeurs par d√©faut.");
    }

    loadSettings();
    renderLinks();
  </script>
</body>
</html>
