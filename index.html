<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Page d'accueil personnalis√©e</title>
  <style>
    /* sensible defaults for responsive behaviour */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      background: #eef2f5;
      text-align: center;
      padding-top: 5%;
    }
    a {
      display: inline-block;
      margin: 10px;
      padding: 8px 16px;
      background: white;
      border-radius: 8px;
      text-decoration: none;
      color: #333;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #005fcc; }
  /* colored variants for specific actions */
  .btn-save { background: #16a34a; color: #fff; }
  .btn-save:hover { background: #15803d; }
  .btn-cancel { background: #6b7280; color: #fff; }
  .btn-cancel:hover { background: #4b5563; }
  .btn-delete { background: #e53935; color: #fff; }
  .btn-delete:hover { background: #b71c1c; }
    /* edit button: fixed bottom-right */
    #editBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      border-radius: 999px;
      padding: 12px 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* reset button: fixed near edit button, hidden by default and shown in edit mode */
    #resetBtn {
      background: #e53935;
      position: fixed;
      bottom: 20px;
      right: 110px;
      z-index: 1000;
      display: none;
      border-radius: 8px;
      padding: 10px 14px;
    }
    #resetBtn:hover { background: #b71c1c; }
    /* background image layer */
    #bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      filter: blur(8px) brightness(0.6);
      transition: background-image 0.3s ease-in-out, opacity 0.3s;
    }
    /* ensure main content is above background */
    body > *:not(#bg) {
      position: relative;
      z-index: 1;
    }
    /* title contrast helpers */
    h1.light-title {
      color: #ffffff;
      text-shadow: 0 4px 18px rgba(0,0,0,0.7);
    }
    h1.dark-title {
      color: #111111;
      text-shadow: 0 2px 6px rgba(255,255,255,0.5);
    }
    /* default settings-panel behavior (overridable by media queries) */
  .settings-panel { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px; }
  input { padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 120px; max-width: 720px; }
    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,120,255,0.12); }
    button { font-size: 14px; }
  /* link item defaults (moved from JS inline styles) */
  .link-item { display: inline-flex; align-items: center; gap: 6px; position: relative; margin: 6px; }
  .link-anchor { cursor: pointer; padding: 8px 12px; display: inline-block; position: relative; }
  .app-badge { display: inline-block; margin-left: 6px; font-size: 0.95em; }
  .link-icon { width: 20px; height: 20px; display: inline-block; margin-right: 8px; vertical-align: middle; }
  .link-icon img { width: 100%; height: 100%; display: block; }
    /* Responsive rules for small screens (phones) */
    @media (max-width: 600px) {
      body { padding-top: 8%; text-align: center; }
      h1 { font-size: 1.6rem; margin: 0 12px 12px; }

      /* make the links container a vertical list on small screens */
      #links { display: flex; flex-direction: column; align-items: center; padding: 0 12px; }

      /* make link items stack and be easy to tap */
      .link-item { display: block; width: 100%; max-width: 560px; margin: 8px auto; }
      .link-item .link-anchor {
        display: block !important;
        width: 100% !important;
        margin: 6px 0 !important;
        padding: 12px 48px 12px 12px !important; /* add right padding to make room for badge */
        box-sizing: border-box;
        text-align: left;
        word-break: break-word;
      }
      /* position the badge to the right of the link on small screens */
      .link-item .app-badge { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); }
  .link-item button { margin-left: 6px; margin-top: 6px; padding: 8px 10px; }

      /* settings panel flows vertically on phones */
  .settings-panel { flex-direction: column !important; align-items: stretch !important; gap: 8px !important; }
  .settings-panel input { width: calc(100% - 32px) !important; max-width: 560px !important; margin: 0 auto !important; }
      .settings-panel button { width: auto !important; }

      /* smaller fixed edit/reset buttons */
      #editBtn { right: 14px; bottom: 14px; padding: 10px 12px; }
      #resetBtn { right: 84px; bottom: 14px; padding: 8px 10px; }
  /* hide bottom export/import controls on small screens (we render them below the add button) */
  #exportBtn, #importBtn { display: none !important; }

      /* slightly reduce blur on small devices for performance */
      #bg { filter: blur(6px) brightness(0.6); }
      /* when in edit mode, add padding under links so fixed buttons don't overlap content */
      body.editing #links { padding-bottom: 220px; }
    }
    /* Extra adjustments for very small screens to avoid overlap */
    @media (max-width: 420px) {
      #editBtn {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        bottom: 12px;
        padding: 12px 14px;
      }
      #resetBtn {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        bottom: 68px;
        display: none; /* hide by default to save space; it will be shown in edit mode by JS */
      }
      /* ensure reset shows in edit mode: JS toggles inline style display; we set a visible size here */
      .show-reset #resetBtn { display: inline-block !important; }
      .link-item .link-anchor { font-size: 16px; padding: 14px !important; }
      /* on very small screens increase bottom padding when editing to avoid overlap */
      body.editing #links { padding-bottom: 320px; }
    }
    .add-link { margin-top: 12px; }
  /* when not on very small screens keep edit/delete inline with link */
  .link-item button { margin-top: 0; }
  /* small move buttons used for reordering */
  .btn-move { background: #f3f4f6; color: #111; padding: 6px 8px; border-radius: 6px; font-weight: 600; }
  .btn-move:hover { background: #e5e7eb; }
  .network-status { margin: 8px auto 0; padding: 8px 12px; border-radius: 8px; max-width: 820px; font-size: 0.95rem; min-height: 44px; }
  /* keep the space even when hidden to avoid layout shift */
  .network-status.hidden { visibility: hidden; }
    .network-status.offline { color: #7f1d1d; background: rgba(183,28,28,0.06); border: 1px solid rgba(183,28,28,0.12); }
    .network-status.online { color: #065f46; background: rgba(6,95,70,0.06); border: 1px solid rgba(6,95,70,0.12); }
  </style>
</head>
<body>
  <div id="bg"></div>
  <h1>Ma page d'accueil üåü</h1>
  <div id="networkStatus" aria-live="polite" class="network-status hidden"></div>
  <div id="links"></div>
  <div>
    <button id="editBtn" onclick="toggleEditMode()">Personnaliser</button>
    <button id="exportBtn" style="display:none; margin-right:6px;">Exporter (JSON)</button>
    <button id="importBtn" style="display:none; margin-right:6px;">Importer (JSON)</button>
    <input id="importInput" type="file" accept="application/json" style="display:none" />
    <button onclick="resetStorage()" id="resetBtn">R√©initialiser</button>
  </div>

  <script>
    const defaultLinks = [
      { name: "Google", url: "https://www.google.com" },
  { name: "YouTube", url: "https://www.youtube.com", appUrl: "vnd.youtube://", intent: "intent://www.youtube.com/#Intent;package=com.google.android.youtube;scheme=https;end", icon: "üìπ" },
  { name: "LinkedIn", url: "https://www.linkedin.com", appUrl: "linkedin://", intent: "intent://www.linkedin.com/#Intent;package=com.linkedin.android;scheme=https;end", icon: "üîó" },
      // appUrl examples: these are best-effort and may vary by platform/version
  { name: "Netflix", url: "https://www.netflix.com", appUrl: "nflx://", intent: "intent://www.netflix.com/#Intent;package=com.netflix.mediaclient;scheme=https;end", icon: "üî¥" },
  { name: "Gmail", url: "https://mail.google.com", appUrl: "googlegmail://", intent: "intent://mail.google.com/#Intent;package=com.google.android.gm;scheme=https;end", icon: "‚úâÔ∏è" },
      { name: "WhatsApp", url: "https://web.whatsapp.com/", appUrl: "whatsapp://send", intent: "intent://send/#Intent;package=com.whatsapp;scheme=https;end", icon: "üí¨" },
      { name: "Drive", url: "https://drive.google.com", appUrl: "googledrive://", intent: "intent://drive.google.com/#Intent;package=com.google.android.apps.docs;scheme=https;end", icon: "üìÅ" }
    ];


    function getLinks() {
      return JSON.parse(localStorage.getItem("links")) || defaultLinks;
    }

    let editMode = false;

    // Apply saved settings (title, background) on load
    function loadSettings() {
      const storedTitle = localStorage.getItem('pageTitle');
      if (storedTitle) {
        document.title = storedTitle;
        const h = document.querySelector('h1');
        if (h) h.textContent = storedTitle;
      }
      const bg = localStorage.getItem('bgImage');
      if (bg) applyBackground(bg);
      else updateTitleContrast(null);
    }

    // Estimate image brightness by drawing it to a small canvas.
    // If cross-origin blocks canvas readback, fallback to conservative choice.
    function analyzeImageBrightness(url, cb) {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = () => {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const w = 40, h = 30;
          canvas.width = w; canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          const data = ctx.getImageData(0, 0, w, h).data;
          let r=0,g=0,b=0,count=0;
          for (let i=0;i<data.length;i+=4) {
            r += data[i]; g += data[i+1]; b += data[i+2]; count++;
          }
          r = r/count; g = g/count; b = b/count;
          const lum = 0.299*r + 0.587*g + 0.114*b;
          cb(null, lum);
        } catch (err) {
          cb(err);
        }
      };
      img.onerror = () => cb(new Error('image load error'));
      img.src = url + ((url.indexOf('?')>-1)?'&':'?') + 'cachebust=' + Date.now();
    }

    function updateTitleContrast(bgUrl) {
      const h = document.querySelector('h1');
      if (!h) return;
      h.classList.remove('light-title','dark-title');
      if (!bgUrl) { h.classList.add('dark-title'); return; }
      analyzeImageBrightness(bgUrl, (err, lum) => {
        if (err || lum === undefined) { h.classList.add('dark-title'); return; }
        if (lum < 130) h.classList.add('light-title'); else h.classList.add('dark-title');
      });
    }

    function saveSettings(title, bgUrl) {
      if (title !== undefined) {
        localStorage.setItem('pageTitle', title);
        document.title = title;
        const h = document.querySelector('h1');
        if (h) h.textContent = title;
      }
      if (bgUrl !== undefined) {
        // validate image first
        if (!bgUrl) {
          // clear background
          localStorage.removeItem('bgImage');
          applyBackground(null);
          return;
        }
        const img = new Image();
        img.onload = () => {
          localStorage.setItem('bgImage', bgUrl);
          applyBackground(bgUrl);
        };
        img.onerror = () => {
          alert('Impossible de charger l\'image de fond. V√©rifie l\'URL.');
        };
        img.src = bgUrl;
      }
    }

    function applyBackground(url) {
      const bgDiv = document.getElementById('bg');
      if (!bgDiv) return;
      if (!url) {
        bgDiv.style.backgroundImage = 'none';
        document.body.style.background = '#eef2f5';
        updateTitleContrast(null);
        return;
      }
      bgDiv.style.backgroundImage = `url(${url})`;
      bgDiv.style.backgroundSize = 'cover';
      bgDiv.style.backgroundPosition = 'center';
      // dim and blur are handled by CSS filter
      document.body.style.background = 'transparent';
      updateTitleContrast(url);
    }

    function renderLinks() {
      const container = document.getElementById("links");
      container.innerHTML = "";
      // If in edit mode, show settings panel for title and background
      if (editMode) {
        const settings = document.createElement('div');
        settings.className = 'settings-panel';

        const titleInput = document.createElement('input');
        titleInput.placeholder = 'Titre de la page';
        titleInput.value = localStorage.getItem('pageTitle') || document.querySelector('h1').textContent || '';

        const bgInput = document.createElement('input');
        bgInput.placeholder = 'URL de l\'image de fond (laisser vide pour effacer)';
        bgInput.value = localStorage.getItem('bgImage') || '';

        const saveSettingsBtn = document.createElement('button');
        saveSettingsBtn.textContent = 'Enregistrer param√®tres';
        saveSettingsBtn.onclick = () => {
          saveSettings(titleInput.value, bgInput.value);
        };
        // remove the default top margin for these inline settings buttons
  saveSettingsBtn.style.marginTop = '0';
  saveSettingsBtn.classList.add('btn-save');

    const cancelSettingsBtn = document.createElement('button');
    cancelSettingsBtn.textContent = 'Annuler';
  cancelSettingsBtn.onclick = () => { renderLinks(); };
  // remove top margin to keep the settings panel compact
  cancelSettingsBtn.style.marginTop = '0';
  cancelSettingsBtn.classList.add('btn-cancel');

        settings.appendChild(titleInput);
        settings.appendChild(bgInput);
        settings.appendChild(saveSettingsBtn);
        settings.appendChild(cancelSettingsBtn);
        container.appendChild(settings);
      }
      const links = getLinks();
        links.forEach((link, idx) => {
  const item = document.createElement('div');
  item.className = 'link-item';

  const a = document.createElement("a");
  a.className = 'link-anchor';
  a.href = link.url;
  a.textContent = link.name || link.url;

        if (editMode) {
          // prevent navigation in edit mode; clicking edits
          a.addEventListener('click', (e) => { e.preventDefault(); editLink(idx); });
        } else {
          // open links in the same page, but try to open native app first when provided
          a.target = '_self';
          const hasApp = link.appUrl || link.intent;
          if (hasApp) {
            a.addEventListener('click', (e) => {
              e.preventDefault();
              tryOpenApp(link);
            });
          }
        }

        item.appendChild(a);

          // show a small badge inside the link if this link has app information (indicates it can open an app)
          // icon (emoji or image) if provided
          if (link.icon) {
            const ic = document.createElement('span');
            ic.className = 'link-icon';
            if (link.icon.match(/^data\//) || link.icon.match(/\.(png|jpg|jpeg|svg)$/i)) {
              const img = document.createElement('img');
              img.src = link.icon;
              img.alt = '';
              ic.appendChild(img);
            } else {
              ic.textContent = link.icon;
            }
            a.insertBefore(ic, a.firstChild);
          }

          if (!editMode && (link.appUrl || link.intent)) {
            const badge = document.createElement('span');
            badge.className = 'app-badge';
            badge.textContent = 'üì±';
            badge.title = 'Ouvrir dans l\'application si disponible';
            a.appendChild(badge);
          }

        if (editMode) {
          const editBtn = document.createElement('button');
          editBtn.textContent = '‚úé';
          editBtn.title = 'Modifier';
          editBtn.onclick = () => editLink(idx);
          item.appendChild(editBtn);

          const delBtn = document.createElement('button');
          delBtn.textContent = 'üóë';
          delBtn.title = 'Supprimer';
          delBtn.onclick = () => { removeLink(idx); };
          delBtn.classList.add('btn-delete');
          item.appendChild(delBtn);

          // move up / down controls for reordering
          const upBtn = document.createElement('button');
          upBtn.textContent = '‚ñ≤';
          upBtn.title = 'Monter';
          upBtn.classList.add('btn-move');
          upBtn.onclick = () => moveLinkUp(idx);
          item.appendChild(upBtn);

          const downBtn = document.createElement('button');
          downBtn.textContent = '‚ñº';
          downBtn.title = 'Descendre';
          downBtn.classList.add('btn-move');
          downBtn.onclick = () => moveLinkDown(idx);
          item.appendChild(downBtn);
        }

        container.appendChild(item);
      });

      if (editMode) {
        const add = document.createElement('div');
        add.className = 'add-link';
        const addBtn = document.createElement('button');
        addBtn.textContent = 'Ajouter un lien';
        addBtn.onclick = addLink;
        // on small screens, render export/import under the add block
        try {
          if (window.matchMedia && window.matchMedia('(max-width: 600px)').matches) {
            const mobileExp = document.createElement('button');
            mobileExp.textContent = 'Exporter (JSON)';
            mobileExp.classList.add('btn-save');
            mobileExp.style.display = 'block';
            mobileExp.style.width = '100%';
            mobileExp.style.marginTop = '8px';
            mobileExp.onclick = exportLinks;
            add.appendChild(mobileExp);

            const mobileImp = document.createElement('button');
            mobileImp.textContent = 'Importer (JSON)';
            mobileImp.classList.add('btn-cancel');
            mobileImp.style.display = 'block';
            mobileImp.style.width = '100%';
            mobileImp.style.marginTop = '6px';
            mobileImp.onclick = () => { const inp = document.getElementById('importInput'); if (inp) inp.click(); };
            add.appendChild(mobileImp);
          }
        } catch (e) {
          // ignore matchMedia errors
        }
        add.appendChild(addBtn);
        container.appendChild(add);
      }
    }

    // Try to open a native app using a scheme or intent, then fallback to the web URL.
    // Improved approach: listen for visibilitychange ‚Äî if the document becomes hidden shortly after
    // attempting the app open, assume the app was launched and don't navigate to the web fallback.
    // Network status helpers
    function setNetworkMessage(message, state) {
      const el = document.getElementById('networkStatus');
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('offline','online','hidden');
      if (!message) { el.classList.add('hidden'); return; }
      if (state === 'offline') el.classList.add('offline'); else el.classList.add('online');
    }

    function updateNetworkStatus() {
      if (navigator.onLine) {
        setNetworkMessage('Tu es en ligne.', 'online');
        setTimeout(() => setNetworkMessage('', ''), 2000);
      } else {
        setNetworkMessage('Hors ligne ‚Äî certain¬∑e¬∑s liens web ne fonctionneront pas.', 'offline');
      }
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    // Try to open a native app using a scheme or intent, then fallback to the web URL.
    // Behaviour: do NOT attempt the web fallback when the browser is offline.
    function tryOpenApp(link) {
      const web = link.url;
      const app = link.appUrl || null;
      const intent = link.intent || null;

      const ua = navigator.userAgent || '';
      const isAndroid = /Android/i.test(ua);

      let hidden = false;
      function onVisibility() { if (document.hidden || document.webkitHidden) hidden = true; }
      document.addEventListener('visibilitychange', onVisibility);
      window.addEventListener('pagehide', onVisibility);

      const tryIntent = () => {
        if (!intent) return false;
        try { window.location.replace(intent); return true; } catch (e) { return false; }
      };
      const tryAppScheme = () => {
        if (!app) return false;
        try { window.location = app; return true; } catch (e) { return false; }
      };

      // If offline, do not attempt to open web fallback; just try app schemes/intents and show message
      const offline = !navigator.onLine;

      if (isAndroid && intent) {
        tryIntent();
        setTimeout(() => {
          if (hidden) return; // app opened
          if (tryAppScheme()) {
            setTimeout(() => { if (hidden) return; if (!offline) window.location.href = web; else setNetworkMessage('Hors ligne ‚Äî impossible d\'ouvrir la version web.', 'offline'); }, 900);
          } else {
            if (!offline) window.location.href = web; else setNetworkMessage('Hors ligne ‚Äî impossible d\'ouvrir la version web.', 'offline');
          }
        }, 800);
        return;
      }

      if (tryAppScheme()) {
        setTimeout(() => { if (hidden) return; if (!offline) window.location.href = web; else setNetworkMessage('Hors ligne ‚Äî impossible d\'ouvrir la version web.', 'offline'); }, 1200);
        return;
      }

      if (!offline) window.location.href = web; else setNetworkMessage('Hors ligne ‚Äî impossible d\'ouvrir la version web.', 'offline');
    }

    // Initialize network status display on load
    updateNetworkStatus();

    // wire up export/import bottom controls
    document.addEventListener('DOMContentLoaded', () => {
      const exp = document.getElementById('exportBtn');
      const imp = document.getElementById('importBtn');
      const inp = document.getElementById('importInput');
      if (exp) exp.onclick = exportLinks;
      if (imp && inp) {
        imp.onclick = () => inp.click();
        inp.onchange = (e) => {
          const f = e.target.files && e.target.files[0];
          if (f) importFromFile(f);
          e.target.value = '';
        };
      }
    });

    function toggleEditMode() {
      editMode = !editMode;
      document.getElementById('editBtn').textContent = editMode ? 'Terminer' : 'Personnaliser';
      // show/hide reset button depending on edit mode
      const reset = document.getElementById('resetBtn');
      if (reset) reset.style.display = editMode ? 'inline-block' : 'none';
      // toggle body classes so mobile CSS can add bottom padding and show reset when needed
    if (editMode) {
      document.body.classList.add('editing');
      document.body.classList.add('show-reset');
      const editBtn = document.getElementById('editBtn'); if (editBtn) editBtn.classList.add('btn-save');
      const exp = document.getElementById('exportBtn'); if (exp) exp.style.display = 'inline-block';
      const imp = document.getElementById('importBtn'); if (imp) imp.style.display = 'inline-block';
    } else {
      document.body.classList.remove('editing');
      document.body.classList.remove('show-reset');
      const editBtn = document.getElementById('editBtn'); if (editBtn) editBtn.classList.remove('btn-save');
      const exp = document.getElementById('exportBtn'); if (exp) exp.style.display = 'none';
      const imp = document.getElementById('importBtn'); if (imp) imp.style.display = 'none';
    }
      renderLinks();
    }

    function editLink(index) {
      const links = getLinks();
      const container = document.getElementById('links');
      // replace the specific item with an edit form
  // find the .link-item elements only (ignore settings panel / other nodes)
  const items = container.querySelectorAll('.link-item');
  const target = items[index];
      if (!target) return;

      const form = document.createElement('div');
      form.style.display = 'inline-block';
      form.style.padding = '8px';
      form.style.background = '#fff';
      form.style.borderRadius = '6px';
      form.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

  const nameInput = document.createElement('input');
  nameInput.value = links[index]?.name || '';
  nameInput.placeholder = 'Nom';
  nameInput.style.marginRight = '6px';

  const urlInput = document.createElement('input');
  urlInput.value = links[index]?.url || 'https://';
  urlInput.placeholder = 'https://...';
  urlInput.style.marginRight = '6px';
  urlInput.style.width = '220px';

  // app-specific fields
  const appInput = document.createElement('input');
  appInput.value = links[index]?.appUrl || '';
  appInput.placeholder = 'Scheme d\'application (ex: vnd.youtube://, whatsapp://)';
  appInput.style.marginTop = '6px';
  appInput.style.display = 'block';
  appInput.style.width = '100%';

  // altAppUrl removed to simplify form

  const intentInput = document.createElement('input');
  intentInput.value = links[index]?.intent || '';
  intentInput.placeholder = 'Intent Android (optionnel)';
  intentInput.style.marginTop = '6px';
  intentInput.style.display = 'block';
  intentInput.style.width = '100%';

  const iconInput = document.createElement('input');
  iconInput.value = links[index]?.icon || '';
  iconInput.placeholder = 'Emoji ou chemin image (ex: data/logo/youtube.png)';
  iconInput.style.marginTop = '6px';
  iconInput.style.display = 'block';
  iconInput.style.width = '100%';

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Enregistrer';
      saveBtn.onclick = () => {
        links[index] = {
          name: nameInput.value || urlInput.value,
          url: urlInput.value,
          appUrl: appInput.value || undefined,
          intent: intentInput.value || undefined,
          icon: iconInput.value || undefined
        };
        localStorage.setItem('links', JSON.stringify(links));
        renderLinks();
      };
  saveBtn.classList.add('btn-save');

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Annuler';
      cancelBtn.style.marginLeft = '6px';
      cancelBtn.onclick = () => { renderLinks(); };
  cancelBtn.classList.add('btn-cancel');

  form.appendChild(nameInput);
  form.appendChild(urlInput);
  form.appendChild(appInput);
  form.appendChild(intentInput);
  form.appendChild(iconInput);
  form.appendChild(saveBtn);
  form.appendChild(cancelBtn);

      target.replaceWith(form);
      nameInput.focus();
    }

    function addLink() {
      const links = getLinks();
      links.push({ name: '', url: 'https://', appUrl: '', intent: '', icon: '' });
      localStorage.setItem('links', JSON.stringify(links));
      renderLinks();
      // open editor for the new last item
      setTimeout(() => editLink(links.length - 1), 50);
    }

    function removeLink(index) {
      const links = getLinks();
      links.splice(index, 1);
      localStorage.setItem('links', JSON.stringify(links));
      renderLinks();
    }

    function moveLinkUp(index) {
      const links = getLinks();
      if (index <= 0 || index >= links.length) return;
      const tmp = links[index-1];
      links[index-1] = links[index];
      links[index] = tmp;
      localStorage.setItem('links', JSON.stringify(links));
      renderLinks();
    }

    function moveLinkDown(index) {
      const links = getLinks();
      if (index < 0 || index >= links.length-1) return;
      const tmp = links[index+1];
      links[index+1] = links[index];
      links[index] = tmp;
      localStorage.setItem('links', JSON.stringify(links));
      renderLinks();
    }

    // Export current data (links + pageTitle + bgImage) as a JSON file
    function exportLinks() {
      const payload = {
        links: getLinks(),
        pageTitle: localStorage.getItem('pageTitle') || null,
        bgImage: localStorage.getItem('bgImage') || null,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'favoris-backup-' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Import JSON file (expects same shape as exportLinks payload)
    function importFromFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!data || !Array.isArray(data.links)) {
            alert('Fichier JSON invalide : le champ "links" est absent ou incorrect.');
            return;
          }
          const ok = confirm('Importer les donn√©es depuis le fichier va remplacer vos favoris locaux. Continuer ?');
          if (!ok) return;
          localStorage.setItem('links', JSON.stringify(data.links));
          if (data.pageTitle) localStorage.setItem('pageTitle', data.pageTitle); else localStorage.removeItem('pageTitle');
          if (data.bgImage) localStorage.setItem('bgImage', data.bgImage); else localStorage.removeItem('bgImage');
          alert('Importation termin√©e.');
          loadSettings();
          renderLinks();
        } catch (err) {
          alert('Erreur lors de la lecture du fichier : ' + err.message);
        }
      };
      reader.onerror = () => alert('Impossible de lire le fichier.');
      reader.readAsText(file);
    }

    function resetStorage() {
      const ok = confirm("Voulez-vous vraiment r√©initialiser les liens enregistr√©s ? Cela restaurera les valeurs par d√©faut.");
      if (!ok) return;
      localStorage.removeItem("links");
      renderLinks();
      alert("Les liens ont √©t√© r√©initialis√©s aux valeurs par d√©faut.");
    }

    loadSettings();
    renderLinks();
  </script>
</body>
</html>
